<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>WireGuard + PiVPN Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="api-token" content="{{ api_token }}">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/particles.js@2.0.0/particles.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="manifest" href="/manifest.json">
  <link rel="stylesheet" href="/static/css/themes.css">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/v36-wide.css') }}">
</head>
<body>
  <div id="particles-js"></div>

  <header class="app-header">
    <div class="brand">
      <h1>ðŸ”’ WireGuard Control</h1>
      <span>Unified PiVPN + system telemetry</span>
    </div>
    <div class="header-actions">
      <div class="header-chip">
        Public QR:
        <strong>{{ 'enabled' if public_qr else 'disabled' }}</strong>
      </div>
      <div class="header-chip">
        Token
        <strong>{{ 'configured' if api_token else 'missing' }}</strong>
      </div>
      <select id="themeSel">
        <option value="dark">Dark</option>
        <option value="light">Light</option>
        <option value="oled">OLED</option>
        <option value="nord">Nord</option>
      </select>
    </div>
  </header>

  <div class="app-shell">
    <aside class="app-nav">
      <div class="nav-group">
        <button data-tab="tab-wg" class="tablink active">
          Overview
          <span>Live peers + graphs</span>
        </button>
        <button data-tab="tab-clients" class="tablink">
          Clients
          <span>PiVPN list & actions</span>
        </button>
        <button data-tab="tab-system" class="tablink">
          System
          <span>Health, logs & power</span>
        </button>
        <button data-tab="tab-tools" class="tablink">
          Tools
          <span>Whitelisted console</span>
        </button>
        <button data-tab="tab-backup" class="tablink">
          Backup
          <span>Config + DB export</span>
        </button>
        <button data-tab="tab-settings" class="tablink">
          Settings
          <span>Helpful toggles</span>
        </button>
      </div>
      <div class="nav-actions">
        <a href="/logout">Logout</a>
      </div>
    </aside>

    <main class="app-main">
      <section class="panel hero">
        <div>
          <h2>Network pulse</h2>
          <p>Watch WireGuard peers, PiVPN clients and Pi health from a single glass panel.</p>
        </div>
        <div class="hero-meta">
          <div>Last refresh <span id="statLastRefresh">â€”</span></div>
          <div>Total peers <span id="statTotalPeers">0</span></div>
          <div>Graphs window <span>60 points</span></div>
        </div>
      </section>

      <section class="panel stat-grid">
        <div class="stat-card">
          <p>Active peers</p>
          <h3 id="statActivePeers">0</h3>
          <span class="stat-trend">Handshakes &lt; 3 min</span>
        </div>
        <div class="stat-card">
          <p>Idle peers</p>
          <h3 id="statIdlePeers">0</h3>
          <span class="stat-trend">Older handshakes</span>
        </div>
        <div class="stat-card">
          <p>Clients generated</p>
          <h3 id="statClients">0</h3>
          <span class="stat-trend">PiVPN total rows</span>
        </div>
        <div class="stat-card">
          <p>System uptime</p>
          <h3 id="statUptime">â€”</h3>
          <span class="stat-trend">Autorefresh 10s</span>
        </div>
      </section>

      <section id="tab-wg" class="panel tab active">
        <div class="section-header">
          <div>
            <h3>WireGuard peers</h3>
            <p class="tab-note">Search, sort and inspect every live peer.</p>
          </div>
          <div class="duo" style="min-width:320px;">
            <input id="search" class="input" placeholder="Filter peers by key or endpoint">
            <button id="btnRefresh" class="btn secondary">Refresh</button>
          </div>
        </div>
        <div class="table-wrap">
          <table class="table">
            <thead>
              <tr>
                <th>Interface</th>
                <th>Public key</th>
                <th>Endpoint</th>
                <th>Allowed IPs</th>
                <th>Handshake</th>
                <th>RX</th>
                <th>TX</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody id="peerTable"></tbody>
          </table>
        </div>

        <div class="split-grid">
          <div class="panel card-ghost">
            <div class="section-header">
              <h3>Interface traffic (RX)</h3>
            </div>
            <canvas id="rxChart" height="140"></canvas>
          </div>
          <div class="panel card-ghost">
            <div class="section-header">
              <h3>Interface traffic (TX)</h3>
            </div>
            <canvas id="txChart" height="140"></canvas>
          </div>
        </div>

        <div class="split-grid">
          <div class="panel card-ghost">
            <div class="section-header">
              <h3>Add peer</h3>
              <span class="tab-note">Append to wg.conf instantly.</span>
            </div>
            <div class="duo">
              <input id="newPub" class="input" placeholder="PublicKey">
              <input id="newIPs" class="input" placeholder="AllowedIPs e.g. 10.6.0.2/32">
            </div>
            <button id="btnAdd" class="btn" style="margin-top:12px;">Add peer</button>
          </div>
          <div class="panel card-ghost">
            <div class="section-header">
              <h3>Offline client generator</h3>
              <span class="tab-note">Creates config &amp; QR in-browser.</span>
            </div>
            <div class="duo" style="align-items:center;">
              <input id="genName" class="input" placeholder="Client name (e.g. phone)">
              <button id="btnGen" class="btn secondary">Generate</button>
              <a id="btnGenDl" class="btn ghost" download="client.conf">Download</a>
              <button id="btnGenQR" class="btn">QR</button>
            </div>
            <pre id="genPreview" class="command-output" style="margin-top:14px; min-height:160px;"></pre>
          </div>
        </div>
      </section>

      <section id="tab-clients" class="panel tab">
        <div class="section-header">
          <div>
            <h3>PiVPN clients</h3>
            <p class="tab-note">Add, revoke, download or show QR per client.</p>
          </div>
          <div class="duo">
            <input id="clientName" class="input" placeholder="Friendly name">
            <input id="clientDays" type="number" class="input" value="365" min="1" style="max-width:130px;">
            <button id="btnAddClient" class="btn">Add client</button>
          </div>
        </div>
        <div class="table-wrap">
          <table class="table">
            <thead>
              <tr>
                <th>#</th>
                <th>Client row</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="clientTable"></tbody>
          </table>
        </div>
      </section>

      <section id="tab-system" class="panel tab">
        <div class="section-header">
          <div>
            <h3>System health</h3>
            <p class="tab-note">Live CPU, memory, disk, temperature and load.</p>
          </div>
          <div class="duo">
            <button class="btn secondary" onclick="wgCtl('restart')">Restart wg0</button>
            <button class="btn secondary" onclick="wgCtl('start')">Start wg0</button>
            <button class="btn secondary" onclick="wgCtl('stop')">Stop wg0</button>
          </div>
        </div>
        <div id="sysBox" class="stat-grid"></div>

        <div class="logs-grid">
          <div class="log-box">
            <div class="section-header">
              <div>
                <h3>WireGuard journal</h3>
              </div>
              <button class="btn secondary" onclick="loadLogs('wg')">Refresh</button>
            </div>
            <pre id="logWg"></pre>
          </div>
          <div class="log-box">
            <div class="section-header">
              <div>
                <h3>System log</h3>
              </div>
              <button class="btn secondary" onclick="loadLogs('syslog')">Refresh</button>
            </div>
            <pre id="logSys"></pre>
          </div>
        </div>

        <div class="duo" style="margin-top:12px;">
          <button class="btn" onclick="power('reboot')">Reboot Pi</button>
          <button class="btn" style="background:var(--danger);" onclick="power('shutdown')">Shutdown Pi</button>
        </div>
      </section>

      <section id="tab-tools" class="panel tab">
        <div class="section-header">
          <div>
            <h3>Command console</h3>
            <p class="tab-note">Safe commands executed through sudo whitelist.</p>
          </div>
        </div>
        <div class="tools-grid">
          <div class="panel card-ghost">
            <label class="tab-note" for="cmdSel">Choose a command</label>
            <select id="cmdSel" class="input" style="margin-top:12px;">
              <option value="wg_show">wg show</option>
              <option value="wg_quick_status">systemctl status wg-quick@wg0</option>
              <option value="ip_addr">ip addr</option>
              <option value="df_h">df -h</option>
              <option value="uptime">uptime</option>
              <option value="tailsys">tail wg log</option>
            </select>
            <button class="btn" style="margin-top:14px;" onclick="runCmd()">Run command</button>
          </div>
          <pre id="cmdOut" class="command-output"></pre>
        </div>
      </section>

      <section id="tab-backup" class="panel tab">
        <div class="section-header">
          <div>
            <h3>Backup / export</h3>
            <p class="tab-note">Bundles wg configs + dashboard DB into a timestamped zip.</p>
          </div>
          <button class="btn" onclick="doBackup()">Download backup</button>
        </div>
      </section>

      <section id="tab-settings" class="panel tab">
        <div class="section-header">
          <div>
            <h3>Environment settings</h3>
            <p class="tab-note">Key flags pulled from .env for quick reference.</p>
          </div>
          <span class="badge">Readonly</span>
        </div>
        <ul style="list-style:none;padding:0;margin:0;display:grid;gap:12px;">
          <li class="panel card-ghost">
            <strong>PUBLIC_QR_ACCESS</strong>
            <p class="tab-note">Currently <b>{{ 'enabled' if public_qr else 'disabled' }}</b>. Toggle via .env.</p>
          </li>
          <li class="panel card-ghost">
            <strong>API token</strong>
            <p class="tab-note">{{ 'Configured and injected into this UI.' if api_token else 'Missing â€“ set API_TOKEN in .env for API access.' }}</p>
          </li>
          <li class="panel card-ghost">
            <strong>ALLOWED_SUBNETS</strong>
            <p class="tab-note">Restrict access to trusted CIDRs. Example: 192.168.0.0/16,10.0.0.0/8.</p>
          </li>
        </ul>
      </section>
    </main>
  </div>

  <div id="qrModal" class="modal" aria-hidden="true">
    <div class="modal-card">
      <button id="qrClose" class="btn secondary" style="position:absolute;top:14px;right:14px;">Close</button>
      <h3 class="text-lg font-semibold mb-3">Client QR</h3>
      <div id="qrContainer"></div>
      <div style="margin-top:16px;display:flex;justify-content:space-between;align-items:center;">
        <div class="tab-note" id="qrName"></div>
        <a id="qrDownload" class="btn" download>Download .conf</a>
      </div>
    </div>
  </div>

  <script src="/static/js/app.js"></script>
  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/sw.js').catch(()=>{});
    }
  </script>
  <script src="{{ url_for('static', filename='js/ui-polish.js') }}"></script>
</body>
</html>
