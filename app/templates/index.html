
<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>WireGuard + PiVPN Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="api-token" content="{{ api_token }}">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/particles.js@2.0.0/particles.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="manifest" href="/manifest.json">
  <link rel="stylesheet" href="/static/css/themes.css">
  <style>
    #particles-js { position:fixed; inset:0; z-index:-1; }
    .tab { display:none; } .tab.active { display:block; }
    .modal { position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.6); backdrop-filter: blur(2px); z-index:50;}
    .modal.active { display:flex; }
  </style>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/v36-wide.css') }}">
</head>
<body class="min-h-screen">
  <div id="particles-js"></div>
  <div class="max-w-7xl mx-auto p-4 md:p-6" style="max-width: inherit !important;">
    <div class="flex gap-4">
      <aside class="w-52 shrink-0 hidden md:block">
        <div class="card p-3 space-y-2">
          <button data-tab="tab-wg" class="tablink block w-full text-left px-3 py-2 rounded hover:bg-slate-700">Dashboard</button>
          <button data-tab="tab-clients" class="tablink block w-full text-left px-3 py-2 rounded hover:bg-slate-700">Clients</button>
          <button data-tab="tab-system" class="tablink block w-full text-left px-3 py-2 rounded hover:bg-slate-700">System</button>
          <button data-tab="tab-tools" class="tablink block w-full text-left px-3 py-2 rounded hover:bg-slate-700">Tools</button>
          <button data-tab="tab-backup" class="tablink block w-full text-left px-3 py-2 rounded hover:bg-slate-700">Backup</button>
          <button data-tab="tab-settings" class="tablink block w-full text-left px-3 py-2 rounded hover:bg-slate-700">Settings</button>
          <a href="/logout" class="block px-3 py-2 rounded hover:bg-slate-700">Logout</a>
        </div>
      </aside>
      <main class="flex-1 space-y-6">
        <div class="flex items-center justify-between">
          <h1 class="text-2xl md:text-3xl font-semibold text-blue-300">ðŸ”’ WireGuard + PiVPN Dashboard</h1>
          <div>
            <select id="themeSel" class="p-2 rounded bg-slate-900 text-white">
              <option value="dark">Dark</option>
              <option value="light">Light</option>
              <option value="oled">OLED</option>
              <option value="nord">Nord</option>
            </select>
          </div>
        </div>

        <section id="tab-wg" class="tab active space-y-6">
          <div class="card p-6">
            <div class="flex items-center gap-3 mb-4">
              <input id="search" placeholder="Search peersâ€¦" class="w-full p-3 rounded bg-slate-900 text-white">
              <button id="btnRefresh" class="px-3 py-2 rounded bg-slate-700 hover:bg-slate-600">Refresh</button>
            </div>
            <div class="overflow-x-auto">
              <table class="min-w-full text-sm">
                <thead class="text-slate-300 border-b border-slate-700">
                  <tr>
                    <th class="py-2 px-3 text-left">Interface</th>
                    <th class="py-2 px-3 text-left">Public Key</th>
                    <th class="py-2 px-3 text-left">Endpoint</th>
                    <th class="py-2 px-3 text-left">Allowed IPs</th>
                    <th class="py-2 px-3 text-left">Handshake</th>
                    <th class="py-2 px-3 text-left">RX</th>
                    <th class="py-2 px-3 text-left">TX</th>
                    <th class="py-2 px-3 text-left">Status</th>
                  </tr>
                </thead>
                <tbody id="peerTable" class="text-slate-100"></tbody>
              </table>
            </div>
          </div>

          <div class="grid md:grid-cols-2 gap-6">
            <div class="card p-6">
              <h2 class="font-medium mb-3">Interface Traffic (RX)</h2>
              <canvas id="rxChart" height="120"></canvas>
            </div>
            <div class="card p-6">
              <h2 class="font-medium mb-3">Interface Traffic (TX)</h2>
              <canvas id="txChart" height="120"></canvas>
            </div>
          </div>

          <div class="grid md:grid-cols-2 gap-6">
            <div class="card p-6">
              <h2 class="font-medium mb-3">Add Peer (public key)</h2>
              <div class="flex flex-col md:flex-row gap-3">
                <input id="newPub" class="flex-1 p-3 rounded bg-slate-900 text-white" placeholder="PublicKey">
                <input id="newIPs" class="flex-1 p-3 rounded bg-slate-900 text-white" placeholder="AllowedIPs e.g. 10.6.0.2/32">
                <button id="btnAdd" class="px-4 py-2 rounded bg-blue-600 hover:bg-blue-700">Add Peer</button>
              </div>
            </div>
            <div class="card p-6">
              <h2 class="font-medium mb-3">Generate Client (offline)</h2>
              <div class="flex flex-col md:flex-row gap-3">
                <input id="genName" class="flex-1 p-3 rounded bg-slate-900 text-white" placeholder="Client name (e.g. phone)">
                <button id="btnGen" class="px-4 py-2 rounded bg-emerald-600 hover:bg-emerald-700">Generate</button>
                <a id="btnGenDl" class="px-4 py-2 rounded bg-slate-700 hover:bg-slate-600" download="client.conf">Download</a>
                <button id="btnGenQR" class="px-4 py-2 rounded bg-indigo-600 hover:bg-indigo-700">QR</button>
              </div>
              <pre id="genPreview" class="mt-3 text-xs whitespace-pre-wrap bg-slate-900 p-3 rounded"></pre>
            </div>
          </div>
        </section>

        <section id="tab-clients" class="tab space-y-6">
          <div class="card p-6">
            <div class="flex items-center gap-3 mb-4">
              <input id="clientName" placeholder="New client name" class="flex-1 p-3 rounded bg-slate-900 text-white">
              <input id="clientDays" type="number" value="365" class="w-28 p-3 rounded bg-slate-900 text-white">
              <button id="btnAddClient" class="px-4 py-2 rounded bg-emerald-600 hover:bg-emerald-700">Add client</button>
            </div>
            <div class="overflow-x-auto">
              <table class="min-w-full text-sm">
                <thead class="text-slate-300 border-b border-slate-700">
                  <tr>
                    <th class="py-2 px-3 text-left">Row</th>
                    <th class="py-2 px-3 text-left">Raw</th>
                    <th class="py-2 px-3 text-left">Actions</th>
                  </tr>
                </thead>
                <tbody id="clientTable" class="text-slate-100"></tbody>
              </table>
            </div>
          </div>
        </section>

        <section id="tab-system" class="tab space-y-6">
          <div class="card p-6">
            <h2 class="font-medium mb-3">System Health</h2>
            <div id="sysBox" class="grid md:grid-cols-3 gap-4 text-sm"></div>
            <div class="mt-4">
              <button class="px-3 py-2 rounded bg-slate-700 hover:bg-slate-600" onclick="wgCtl('restart')">Restart wg0</button>
              <button class="px-3 py-2 rounded bg-slate-700 hover:bg-slate-600" onclick="wgCtl('start')">Start wg0</button>
              <button class="px-3 py-2 rounded bg-slate-700 hover:bg-slate-600" onclick="wgCtl('stop')">Stop wg0</button>
            </div>
            <div class="mt-6 grid md:grid-cols-2 gap-4">
              <div class="card p-4">
                <div class="flex items-center justify-between mb-2">
                  <h3 class="font-medium">Logs: WireGuard</h3>
                  <button class="px-2 py-1 rounded bg-slate-700 hover:bg-slate-600" onclick="loadLogs('wg')">Refresh</button>
                </div>
                <pre id="logWg" class="text-xs bg-slate-900 p-3 rounded max-h-64 overflow-auto"></pre>
              </div>
              <div class="card p-4">
                <div class="flex items-center justify-between mb-2">
                  <h3 class="font-medium">Logs: System</h3>
                  <button class="px-2 py-1 rounded bg-slate-700 hover:bg-slate-600" onclick="loadLogs('syslog')">Refresh</button>
                </div>
                <pre id="logSys" class="text-xs bg-slate-900 p-3 rounded max-h-64 overflow-auto"></pre>
              </div>
            </div>
            <div class="mt-4 flex gap-3">
              <button class="px-3 py-2 rounded bg-rose-700 hover:bg-rose-600" onclick="power('reboot')">Reboot Pi</button>
              <button class="px-3 py-2 rounded bg-rose-700 hover:bg-rose-600" onclick="power('shutdown')">Shutdown Pi</button>
            </div>
          </div>
        </section>

        <section id="tab-tools" class="tab space-y-6">
          <div class="card p-6">
            <h2 class="font-medium mb-3">Console (whitelisted commands)</h2>
            <div class="flex gap-2">
              <select id="cmdSel" class="p-2 rounded bg-slate-900 text-white">
                <option value="wg_show">wg show</option>
                <option value="wg_quick_status">systemctl status wg-quick@wg0</option>
                <option value="ip_addr">ip addr</option>
                <option value="df_h">df -h</option>
                <option value="uptime">uptime</option>
                <option value="tailsys">tail wg log</option>
              </select>
              <button class="px-3 py-2 rounded bg-slate-700 hover:bg-slate-600" onclick="runCmd()">Run</button>
            </div>
            <pre id="cmdOut" class="mt-3 text-xs bg-slate-900 p-3 rounded max-h-80 overflow-auto"></pre>
          </div>
        </section>

        <section id="tab-backup" class="tab space-y-6">
          <div class="card p-6">
            <h2 class="font-medium mb-3">Backup / Export</h2>
            <p class="text-sm text-slate-400">Creates a zip of your WireGuard configs and the dashboard database.</p>
            <button class="px-3 py-2 rounded bg-blue-600 hover:bg-blue-700" onclick="doBackup()">Download Backup</button>
          </div>
        </section>

        <section id="tab-settings" class="tab space-y-6">
          <div class="card p-6">
            <h2 class="font-medium mb-3">QR Access</h2>
            <p class="text-sm text-slate-400">Public QR access (no token) is <b>{{ 'enabled' if public_qr else 'disabled' }}</b>. Change via <code>PUBLIC_QR_ACCESS</code> in <code>.env</code>.</p>
          </div>
        </section>
      </main>
    </div>
  </div>

  <div id="qrModal" class="modal" aria-hidden="true">
    <div class="bg-slate-900 rounded-2xl shadow-xl border border-white/10 p-4 md:p-6 w-[95%] max-w-md relative">
      <button id="qrClose" class="absolute top-3 right-3 px-2 py-1 rounded bg-slate-700 hover:bg-slate-600">Close</button>
      <h3 class="text-lg font-semibold mb-3">Client QR</h3>
      <div id="qrContainer" class="flex items-center justify-center bg-white rounded p-3 min-h-[240px]"></div>
      <div class="mt-4 flex items-center justify-between">
        <div class="text-xs text-slate-400" id="qrName"></div>
        <a id="qrDownload" class="px-3 py-2 rounded bg-blue-600 hover:bg-blue-700 text-sm">Download .conf</a>
      </div>
    </div>
  </div>

  <script src="/static/js/app.js"></script>
  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/sw.js').catch(()=>{});
    }
  </script>
  <script src="{{ url_for('static', filename='js/ui-polish.js') }}"></script>

<!-- About Modal -->
<div class="modal" id="aboutModal">
  <div class="modal-card">
    <div class="flex" style="justify-content:space-between;align-items:center">
      <h3 style="margin:0">About PiVPN Dashboard</h3>
      <button class="btn secondary" id="aboutClose">Close</button>
    </div>
    <hr class="sep">
    <div id="aboutContent" class="content"></div>
  </div>
</div>

</body>
</html>
